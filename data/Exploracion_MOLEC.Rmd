---
title: "Exploración MOLEC"
author: "Fernando Ruiz"
date: "`r Sys.Date()`"
output: word_document
---

# Exploración de las bases 2019, 2021 y 2023

```{r}
library(readr)
library(dplyr)

# Detecta si el script se ejecuta dentro de la carpeta data
data_dir <- if ("Datos_molec_2019.csv" %in% list.files()) "." else "data"

M19 <- read_csv(file.path(data_dir, "Datos_molec_2019.csv"),
                locale = locale(encoding = "Latin1"))
M21 <- read_csv(file.path(data_dir, "Datos_molec_2021.CSV"),
                locale = locale(encoding = "Latin1"))
M23 <- read_csv(file.path(data_dir, "Datos_molec_2023.CSV"),
                locale = locale(encoding = "Latin1"))
```

## Dimensiones

```{r}
dim(M19)
dim(M21)
dim(M23)
```

## Resumen rápido

```{r}
summary(M19)
summary(M21)
summary(M23)
```

# Selección de variables de interés

```{r}
vars_fln_casa <- c("p34_1", "p34_2", "p34_3")
vars_fln_escuela <- c("p36_1", "p36_2", "p36_3", "p36_4")
vars_fln <- c(vars_fln_casa, vars_fln_escuela)
vars_ala <- c("p4", "p10", "p16", "p26")

vars_interes <- c(vars_ala, vars_fln, "factor")

M19_sel <- M19[vars_interes]
M21_sel <- M21[vars_interes]
M23_sel <- M23[vars_interes]
```

## Datos perdidos o faltantes

```{r}
summary(M19_sel)
summary(M21_sel)
summary(M23_sel)
```

# Conversión de ceros a NA y guardado

Las preguntas seleccionadas utilizan el código `0` para indicar que la pregunta no aplica. Se convierte ese código en `NA` antes de combinar las bases.

```{r}
vars_cero <- c("p4", "p10", "p16", "p26")
vars_no_recuerda <- c("p34_1", "p34_2", "p34_3", "p36_1", "p36_2", "p36_3", "p36_4")

limpia_ceros <- function(df, year) {
  df %>%
    mutate(across(all_of(vars_cero), ~ ifelse(. == 0, NA, .))) %>%
    mutate(across(all_of(vars_no_recuerda), ~ ifelse(. %in% c(0, 3), NA, .))) %>%
    mutate(year = year)
}

M19_clean <- limpia_ceros(M19_sel, 2019)
M21_clean <- limpia_ceros(M21_sel, 2021)
M23_clean <- limpia_ceros(M23_sel, 2023)

molec_light <- bind_rows(M19_clean, M21_clean, M23_clean)
```

## Verificación final

```{r}
summary(molec_light)
```

## Exportación

```{r}
output_dir <- if (data_dir == ".") "." else "data"
output_path <- file.path(output_dir, "nuevo_molec_light_2019_2021_2023.csv")
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

write.csv(molec_light, output_path, row.names = FALSE)
output_path
```

El archivo `data/molec_light_2019_2021_2023.csv` contiene las tres bases con las variables de interés y los valores `0` convertidos a `NA`.
